<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Rätselliste</title>

<!-- jQuery und DataTables -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<!-- Chart.js für Statistiken -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body { font-family: Arial, sans-serif; margin: 20px; background-color:#f7f7f7; color:#222; transition:all 0.3s ease; }
body.dark-mode { background:#222; color:#eee; }
h1 { text-align: center; margin-bottom: 20px; }
button, input[type="file"], select, input[type="text"], input[type="number"] { margin: 5px; padding: 6px 10px; cursor: pointer; }
.stats { margin-top: 20px; background-color: #fff; padding: 15px; border-radius: 5px; }
body.dark-mode .stats { background:#333; }
#puzzle-table_wrapper { margin-top: 20px; }
.puzzle-grid { font-family: monospace; white-space: pre; background: #f0f0f0; padding: 5px; border-radius: 5px; margin-top: 5px; }
body.dark-mode .puzzle-grid { background:#444; }
.filter-group { margin:10px 0; }
#charts-container { display: flex; flex-wrap: wrap; gap: 20px; margin-top: 20px; }
.chart-box { background: #fff; padding: 15px; border-radius: 5px; width: 400px; }
body.dark-mode .chart-box { background:#333; }
</style>
</head>
<body>

<h1>Rätselliste</h1>

<div class="filter-group">
    <button id="toggle-dark">Darkmode</button>
    <button id="export-csv">CSV</button>
    <button id="export-pdf">PDF</button>
    <button id="export-png">PNG</button>
</div>

<div class="filter-group">
    <label for="filter-category">Kategorie:</label>
    <select id="filter-category" multiple size="5" style="width:200px"></select>

    <label for="filter-name">Name enthält:</label>
    <input type="text" id="filter-name">

    <label for="filter-minletters">Min Buchstaben:</label>
    <input type="number" id="filter-minletters" style="width:60px">

    <label for="filter-maxletters">Max Buchstaben:</label>
    <input type="number" id="filter-maxletters" style="width:60px">

    <label for="filter-minwords">Min Zeilen:</label>
    <input type="number" id="filter-minwords" style="width:60px">

    <label for="filter-maxwords">Max Zeilen:</label>
    <input type="number" id="filter-maxwords" style="width:60px">

    <button id="apply-filters">Filter anwenden</button>
    <button id="reset-filters">Filter zurücksetzen</button>
</div>

<div class="stats">
    <h2>Statistiken</h2>
    <p id="total-puzzles">Anzahl Rätsel: 0</p>
    <p id="total-categories">Anzahl Kategorien: 0</p>
    <div id="category-stats"></div>
</div>

<div id="charts-container">
    <div class="chart-box">
        <h3>Kategorien</h3>
        <canvas id="categoryChart"></canvas>
    </div>
    <div class="chart-box">
        <h3>Buchstaben pro Rätsel</h3>
        <canvas id="lettersChart"></canvas>
    </div>
    <div class="chart-box">
        <h3>Begriffe pro Rätsel</h3>
        <canvas id="termsChart"></canvas>
    </div>
</div>

<table id="puzzle-table" class="display">
    <thead>
        <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Kategorie</th>
            <th>Buchstaben</th>
            <th>Anzahl Zeilen</th>
            <th>Anzahl Begriffe</th>
            <th>Rätsel</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<script>
let puzzles = {};
let table;
let categoryChart, lettersChart, termsChart;
let lastJson = '';

// Darkmode Toggle
$("#toggle-dark").click(function(){ $("body").toggleClass("dark-mode"); });

// Begriffe zählen (jede Zeile + Trennstriche)
function countWords(puzzle){
    let count = 0;
    puzzle.forEach(row => {
        const joined = row.join('').trim();
        if(joined.length===0) return;
        let parts = joined.split(/[\s-]+/).filter(p => p.length>0);
        count += parts.length;
    });
    return count;
}

function renderPuzzles(data){
    const tbody = $("#puzzle-table tbody");
    tbody.empty();

    let categories = new Set();
    let categoryCount = {};

    Object.keys(data).forEach(id=>{
        const p = data[id];
        const letters = p.puzzle.flat().filter(c=>c!==' ').length;
        const words = p.puzzle.length;
        const terms = countWords(p.puzzle);
        const puzzleStr = p.puzzle.map(r=>r.join('')).join('\n');

        tbody.append(`
            <tr>
                <td>${id}</td>
                <td>${p.name}</td>
                <td>${p.category}</td>
                <td>${letters}</td>
                <td>${words}</td>
                <td>${terms}</td>
                <td><div class="puzzle-grid">${puzzleStr}</div></td>
            </tr>
        `);

        categories.add(p.category);
        categoryCount[p.category] = (categoryCount[p.category]||0)+1;
    });

    $("#total-puzzles").text("Anzahl Rätsel: "+Object.keys(data).length);
    $("#total-categories").text("Anzahl Kategorien: "+categories.size);

    let catStatsHtml = "<ul>";
    categories.forEach(cat => catStatsHtml += `<li>${cat}: ${categoryCount[cat]} Rätsel</li>`);
    catStatsHtml += "</ul>";
    $("#category-stats").html(catStatsHtml);

    // Kategorie Filter
    const filterCat = $("#filter-category");
    filterCat.empty();
    categories.forEach(cat=>filterCat.append(`<option value="${cat}">${cat}</option>`));

    // DataTable
    if(table) table.destroy();
    table = $('#puzzle-table').DataTable({
        order:[[0,'asc']], 
        autoWidth:false,
        lengthMenu:[[5,10,20,50,100,150,200,250,500,-1],[5,10,20,50,100,150,200,250,500,"alle"]]
    });

    updateChartsFiltered();
}

// JSON laden
function loadJson(){
    $.getJSON("puzzles.json", function(data){
        const jsonStr = JSON.stringify(data);
        if(jsonStr !== lastJson){
            lastJson = jsonStr;
            puzzles = data;
            renderPuzzles(puzzles);
        }
    }).fail(function(){ console.error("Fehler beim Laden der puzzles.json"); });
}

// Auto Reload nur bei Änderung alle 5 Sekunden
setInterval(loadJson,5000);
loadJson();

// Charts erstellen/aktualisieren
function updateCharts(data){
    const catCounts = {};
    const lettersCounts = [];
    const termsCounts = [];

    Object.entries(data).forEach(([id,p])=>{
        catCounts[p.category]=(catCounts[p.category]||0)+1;
        lettersCounts.push(p.puzzle.flat().filter(c=>c!==' ').length);
        termsCounts.push(countWords(p.puzzle));
    });

    const catLabels = Object.keys(catCounts);
    const catData = Object.values(catCounts);

    if(categoryChart) categoryChart.destroy();
    categoryChart = new Chart(document.getElementById('categoryChart').getContext('2d'), {
        type:'bar',
        data:{labels:catLabels,datasets:[{label:'Anzahl Rätsel',data:catData,backgroundColor:'rgba(54,162,235,0.6)'}]},
        options:{responsive:true,plugins:{legend:{display:false}}}
    });

    if(lettersChart) lettersChart.destroy();
    lettersChart = new Chart(document.getElementById('lettersChart').getContext('2d'), {
        type:'bar',
        data:{labels:Object.keys(data),datasets:[{label:'Buchstaben',data:lettersCounts,backgroundColor:'rgba(255,99,132,0.6)'}]},
        options:{responsive:true}
    });

    if(termsChart) termsChart.destroy();
    termsChart = new Chart(document.getElementById('termsChart').getContext('2d'), {
        type:'bar',
        data:{labels:Object.keys(data),datasets:[{label:'Begriffe',data:termsCounts,backgroundColor:'rgba(75,192,192,0.6)'}]},
        options:{responsive:true}
    });
}

function updateChartsFiltered(){
    const filteredData = {};
    table.rows({search:'applied'}).every(function(){
        const d = this.data();
        filteredData[d[0]] = puzzles[d[0]];
    });
    updateCharts(filteredData);
}

// Filter
$("#apply-filters").on("click", function(){
    const selectedCats = $("#filter-category").val() || [];
    const nameFilter = $("#filter-name").val().toLowerCase();
    const minLetters = parseInt($("#filter-minletters").val())||0;
    const maxLetters = parseInt($("#filter-maxletters").val())||Infinity;
    const minWords = parseInt($("#filter-minwords").val())||0;
    const maxWords = parseInt($("#filter-maxwords").val())||Infinity;

    table.rows().every(function(){
        const d=this.data();
        const id=d[0], name=d[1].toLowerCase(), cat=d[2], letters=parseInt(d[3]), words=parseInt(d[4]);
        let catMatch=selectedCats.length===0||selectedCats.includes(cat);
        let nameMatch=name.includes(nameFilter);
        let lettersMatch=letters>=minLetters&&letters<=maxLetters;
        let wordsMatch=words>=minWords&&words<=maxWords;
        if(catMatch&&nameMatch&&lettersMatch&&wordsMatch) $(this.node()).show();
        else $(this.node()).hide();
    });
    updateChartsFiltered();
});

$("#reset-filters").on("click", function(){
    $("#filter-category").val([]);
    $("#filter-name").val('');
    $("#filter-minletters,#filter-maxletters,#filter-minwords,#filter-maxwords").val('');
    table.rows().every(function(){ $(this.node()).show(); });
    updateChartsFiltered();
});

// Exporte
function exportCSV(){
    let csv="ID,Name,Kategorie,Buchstaben,Anzahl Zeilen,Anzahl Begriffe,Rätsel\n";
    table.rows({search:'applied'}).every(function(){
        const d=this.data();
        let puzzleText=d[6].replace(/\n/g,"|");
        csv+=[d[0],d[1],d[2],d[3],d[4],d[5],`"${puzzleText}"`].join(",")+"\n";
    });
    saveAs(new Blob([csv],{type:'text/csv;charset=utf-8;'}),"puzzles.csv");
}

function exportPDF(){
    const { jsPDF } = window.jspdf;
    const doc=new jsPDF('p','pt');
    doc.text("Rätselwand",20,20);
    doc.autoTable({html:"#puzzle-table",startY:40});
    doc.save("puzzles.pdf");
}

function exportPNG(){
    html2canvas(document.body).then(canvas=>{
        canvas.toBlob(function(blob){ saveAs(blob,"puzzles.png"); });
    });
}

$("#export-csv").click(exportCSV);
$("#export-pdf").click(exportPDF);
$("#export-png").click(exportPNG);
</script>

</body>
</html>
